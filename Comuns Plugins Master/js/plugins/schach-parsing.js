//=============================================================================
// Schach - Parsing
//=============================================================================

/*:
 *
 * @target MZ
 * @plugindesc Parsing core library.
 * @author Brandt
 * 
 * @url https://github.com/comuns-rpgmaker/schach-parsing
 * 
 * @help Schach Parsing.
 * 
 * This is a core library for expression parsing. This script does not provide
 * any functionality by itself, only functions that ought to be used by other
 * scripts to make sense of generic user input.
 *
 */

//=============================================================================
// ** NOTICE **
//-----------------------------------------------------------------------------
// The code below is generated by a compiler, and is not well suited for human
// reading. If you are interested on the source code, please take a look at
// the Github repository for this plugin!
//=============================================================================

this.Schach=this.Schach||{},this.Schach.Parsing=function(){"use strict";var r=function(t,n){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,t){r.__proto__=t}||function(r,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])})(t,n)};function t(t,n){function e(){this.constructor=t}r(t,n),t.prototype=null===n?Object.create(n):(e.prototype=n.prototype,new e)}var n=function(){return(n=Object.assign||function(r){for(var t,n=1,e=arguments.length;n<e;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(r[o]=t[o]);return r}).apply(this,arguments)};function e(r,t){var n="function"==typeof Symbol&&r[Symbol.iterator];if(!n)return r;var e,o,u=n.call(r),i=[];try{for(;(void 0===t||t-- >0)&&!(e=u.next()).done;)i.push(e.value)}catch(r){o={error:r}}finally{try{e&&!e.done&&(n=u.return)&&n.call(u)}finally{if(o)throw o.error}}return i}function o(){for(var r=[],t=0;t<arguments.length;t++)r=r.concat(e(arguments[t]));return r}var u=function(){function r(){}return r.prototype.flatMap=function(r){return new i(this,r)},r.prototype.map=function(r){return new c(this,r)},r.prototype.zip=function(r){return this.flatMap((function(t){return r.map((function(r){return[t,r]}))}))},r.prototype.error=function(r){return new f(this,r)},r.prototype.or=function(r){return new a(this,r)},r.prototype.thenDrop=function(r){return this.flatMap((function(t){return("function"==typeof r?r():r).map((function(){return t}))}))},r.prototype.dropThen=function(r){return this.flatMap((function(){return"function"==typeof r?r():r}))},r}(),i=function(r){function e(t,n){var e=r.call(this)||this;return e._parser=t,e._functor=n,e}return t(e,r),e.prototype.run=function(r){var t=this._parser.run(r);return t.success?this._functor(t.parsed).run(t.rest):n(n({},t),{parsed:void 0})},e}(u),c=function(r){function e(t,n){var e=r.call(this)||this;return e._parser=t,e._functor=n,e}return t(e,r),e.prototype.run=function(r){var t=this._parser.run(r);return t.success?n(n({},t),{parsed:this._functor(t.parsed)}):n(n({},t),{parsed:void 0})},e}(u),a=function(r){function n(t,n){var e=r.call(this)||this;return e._parser=t,e._fallback=n,e}return t(n,r),n.prototype.run=function(r){var t=this._parser.run(r);return t.success?t:"function"==typeof this._fallback?this._fallback().run(r):this._fallback.run(r)},n}(u),f=function(r){function e(t,n){var e=r.call(this)||this;return e._parser=t,e._mapper=n,e}return t(e,r),e.prototype.run=function(r){var t=this._parser.run(r);return t.success?t:n(n({},t),{message:this._mapper(t.parsed,t.context)})},e}(u),p=function(r){function n(t){var n=r.call(this)||this;return n._value=t,n}return t(n,r),n.prototype.run=function(r){return{success:!0,parsed:this._value,rest:r}},n}(u);function s(r){return new p(r)}function h(){for(var r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];return r.slice(1).reduce((function(r,t){return r.flatMap((function(r){return t.map((function(t){return r.concat(t)}))}))}),r[0].map(Array.of))}function l(){for(var r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];return r.reduce((function(r,t){return r.or(t)}))}function y(r){return r.flatMap((function(t){return v(r).map((function(r){return[t].concat(r)}))}))}function v(r){return y(r).or(s([]))}var m=function(r){function n(t){var n=r.call(this)||this;return n._codePoint=t,n}return t(n,r),n.prototype.run=function(r){var t=r.codePointAt(0);if(t===this._codePoint)return{success:!0,parsed:this._codePoint,rest:r.substr(1)};var n=String.fromCodePoint(this._codePoint),e="number"==typeof t?String.fromCodePoint(t):"<eos>";return{success:!1,message:"expected '"+n+"', got '"+e+"'",context:e,rest:r}},n}(u);function _(r){if("string"==typeof r){var t=r.codePointAt(0);if(void 0===t)throw"string is empty";r=t}return new m(r)}function d(r){return h.apply(void 0,o(Array.from(r).map(_))).map((function(r){return String.fromCodePoint.apply(String,o(r))})).error((function(t,n){return'expected "'+r+'", got "'+(n||"")+'"'}))}function g(r){return r-48}var b=Array.from({length:10},(function(r,t){return t.toString()}));function M(){return l.apply(void 0,o(b.map(_))).map(g).error((function(r,t){return"expected 0-9, got '"+t+"'"}))}function O(){return v(_(" "))}var P=Object.freeze({__proto__:null,char:_,string:d,digit:M,spaces:O});function w(){return y(M()).map((function(r){return r.reduce((function(r,t){return 10*r+t}))}))}var j=_("-").thenDrop(O).dropThen(s(-1)).or(_("+").dropThen(s(1))).or(s(1)),x=_(".").dropThen(y(M())).map((function(r){return r.reduceRight((function(r,t){return t+r/10}))/10})),S=_("e").dropThen(j.flatMap((function(r){return w().map((function(t){return r*t}))}))).map((function(r){return Math.pow(10,r)})).or(s(1));function T(){return j.flatMap((function(r){return w().flatMap((function(t){return x.map((function(n){return r*(t+n)})).or(s(t))})).or(x).flatMap((function(r){return S.map((function(t){return r*t}))})).error((function(r,t){return"expected number, got '"+t+"'"}))}))}function A(){return T().map((function(r){return{type:"number",value:r}}))}var k=function(r,t){var n=t;return n.priority=r,n},D={"+":k(0,(function(r,t){return r+t})),"-":k(0,(function(r,t){return r-t})),"/":k(1,(function(r,t){return r/t})),"*":k(1,(function(r,t){return r*t})),"^":k(2,Math.pow)},z=l.apply(void 0,o(Object.keys(D).map(d))).map((function(r){return D[r]})).error((function(r,t){return"expected operator ("+Object.keys(D).join(", ")+"), got '"+t+"'"})).map((function(r){return{type:"operator",operator:r}})),C=function(r){return r.thenDrop(O).flatMap((function(r){return z.map((function(t){return n(n({},t),{left:r})}))})).thenDrop(O).flatMap((function(t){return C(r).map((e=t,function(r){return function(r,t){return r.priority>t.priority}(e.operator,r.operator)?n(n({},r),{left:n(n({},e),{right:r.left})}):n(n({},e),{right:r})})).or(r.map((function(r){return n(n({},t),{right:r})})));var e}))};function q(){var r=_("(").dropThen(O).dropThen(q).thenDrop(O).thenDrop(_(")")).or(A());return C(r).or(r)}var E=Object.freeze({__proto__:null,integer:w,number:T,numberExpression:A,operation:C,expression:q,evaluate:function r(t){return"number"===t.type?t.value:t.operator(r(t.left),r(t.right))}});return Object.freeze({__proto__:null,Text:P,Arithmetic:E,Parser:u,pure:s,sequence:h,oneOf:l,many1:y,many:v})}();